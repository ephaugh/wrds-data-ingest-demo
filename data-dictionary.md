# WRDS Data Ingestion Demo - Data Dictionary

**Version**: 1.0  
**Last Updated**: 2025-10-27

This document provides comprehensive documentation of all data structures, schemas, and file formats used in the WRDS Data Ingestion Demo pipeline.

---

## Table of Contents

1. [Database Schema](#database-schema)
2. [CSV Files](#csv-files)
3. [Data Types Reference](#data-types-reference)
4. [Business Rules & Calculations](#business-rules--calculations)
5. [Data Quality Notes](#data-quality-notes)

---

## Database Schema

### Table: `prices_daily`

**Location**: `db/marketdata.db`  
**Purpose**: Store daily OHLCV (Open, High, Low, Close, Volume) price data for equity securities  
**Update Pattern**: Idempotent upsert (DELETE + INSERT)

#### Schema Definition

```sql
CREATE TABLE prices_daily (
    date TEXT NOT NULL,
    symbol TEXT NOT NULL,
    open REAL,
    high REAL,
    low REAL,
    close REAL,
    adj_close REAL,
    volume INTEGER,
    PRIMARY KEY (date, symbol)
);

CREATE INDEX idx_symbol_date ON prices_daily (symbol, date);
```

#### Column Specifications

| Column | Data Type | Nullable | Description | Example Value |
|--------|-----------|----------|-------------|---------------|
| `date` | TEXT | NO | Trading date in ISO 8601 format (YYYY-MM-DD) | `2024-10-15` |
| `symbol` | TEXT | NO | Stock ticker symbol (uppercase) | `AAPL` |
| `open` | REAL | YES | Opening price for the trading day (USD) | `175.23` |
| `high` | REAL | YES | Highest price during the trading day (USD) | `178.45` |
| `low` | REAL | YES | Lowest price during the trading day (USD) | `174.80` |
| `close` | REAL | YES | Closing price for the trading day (USD) | `177.90` |
| `adj_close` | REAL | YES | Adjusted closing price (accounts for splits, dividends) | `176.85` |
| `volume` | INTEGER | YES | Number of shares traded during the day | `54321000` |

#### Indexes

- **Primary Key**: Composite key on `(date, symbol)` ensures uniqueness per symbol per day
- **Index**: `idx_symbol_date` on `(symbol, date)` optimizes queries filtering by symbol

#### Business Rules

1. **Primary Key Constraint**: One record per symbol per trading date
2. **Date Format**: Always YYYY-MM-DD (ISO 8601)
3. **Symbol Format**: Always uppercase ticker symbols
4. **Price Precision**: Stored as REAL (typically 2 decimal places for USD)
5. **Adjusted Close**: Preferred for return calculations as it accounts for corporate actions

#### Sample Query Patterns

```sql
-- Get all data for a specific symbol
SELECT * FROM prices_daily 
WHERE symbol = 'AAPL' 
ORDER BY date DESC;

-- Get latest price for each symbol
SELECT symbol, MAX(date) as latest_date, adj_close
FROM prices_daily
GROUP BY symbol;

-- Calculate date range coverage
SELECT 
    symbol,
    MIN(date) as first_date,
    MAX(date) as last_date,
    COUNT(*) as trading_days
FROM prices_daily
GROUP BY symbol;

-- Find high-volume trading days
SELECT date, symbol, volume, adj_close
FROM prices_daily
WHERE volume > (SELECT AVG(volume) * 2 FROM prices_daily WHERE symbol = 'AAPL')
  AND symbol = 'AAPL'
ORDER BY volume DESC
LIMIT 10;
```

---

## CSV Files

### 1. `data/prices_raw.csv`

**Purpose**: Intermediate storage of normalized raw price data from external API  
**Generated By**: `fetch_data.py`  
**Consumed By**: `load_to_db.py`  
**Row Count**: ~2,500 (10 symbols × 250 trading days)

#### Schema

| Column | Data Type | Description | Example |
|--------|-----------|-------------|---------|
| `date` | STRING | Trading date (YYYY-MM-DD) | `2024-10-15` |
| `symbol` | STRING | Stock ticker symbol | `MSFT` |
| `open` | FLOAT | Opening price (USD) | `412.35` |
| `high` | FLOAT | High price (USD) | `415.67` |
| `low` | FLOAT | Low price (USD) | `410.89` |
| `close` | FLOAT | Closing price (USD) | `414.22` |
| `adj_close` | FLOAT | Adjusted close (USD) | `413.98` |
| `volume` | INTEGER | Shares traded | `18234567` |

#### Sample Data

```csv
date,symbol,open,high,low,close,adj_close,volume
2024-10-15,AAPL,175.23,178.45,174.80,177.90,176.85,54321000
2024-10-15,MSFT,412.35,415.67,410.89,414.22,413.98,18234567
2024-10-16,AAPL,177.50,179.20,176.30,178.80,177.75,49876000
```

#### Notes

- Source: Yahoo Finance API via `yfinance` library
- All symbols concatenated into single file
- Sorted by symbol, then date
- Missing data represented as empty cells or NaN

---

### 2. `reports/summary.csv`

**Purpose**: Per-symbol summary statistics for daily returns  
**Generated By**: `analyze_data.py`  
**Update Frequency**: Each pipeline run

#### Schema

| Column | Data Type | Description | Example | Units |
|--------|-----------|-------------|---------|-------|
| `symbol` | STRING | Stock ticker symbol | `GOOGL` | - |
| `obs` | INTEGER | Number of daily return observations | `251` | count |
| `mean_daily_return` | FLOAT | Average daily return | `0.00123` | decimal (0.123%) |
| `std_daily_return` | FLOAT | Standard deviation of daily returns | `0.0187` | decimal (1.87%) |
| `avg_volume` | FLOAT | Average daily trading volume | `54321000.0` | shares |

#### Calculation Details

```python
# Daily return calculation
daily_return = (adj_close_today - adj_close_yesterday) / adj_close_yesterday

# obs: Count of valid returns (excludes first day which has no prior price)
obs = count(daily_return) where daily_return is not null

# mean_daily_return: Arithmetic mean
mean_daily_return = sum(daily_return) / obs

# std_daily_return: Standard deviation (sample)
std_daily_return = sqrt(sum((daily_return - mean)^2) / (obs - 1))

# avg_volume: Simple average
avg_volume = sum(volume) / count(volume)
```

#### Sample Data

```csv
symbol,obs,mean_daily_return,std_daily_return,avg_volume
AAPL,251,0.00123,0.0187,54321000.0
MSFT,251,0.00098,0.0165,32100000.0
GOOGL,251,0.00145,0.0203,21234567.0
```

#### Interpretation Guide

- **mean_daily_return**: 
  - `0.001` = 0.1% average daily gain
  - Positive = upward trend
  - Negative = downward trend
  
- **std_daily_return**:
  - Higher values = more volatile
  - Typical range: 0.01 (1%) to 0.05 (5%) for large-cap stocks
  
- **avg_volume**:
  - Higher = more liquid
  - Useful for assessing trading ease

---

### 3. `reports/volatility.csv`

**Purpose**: Latest 20-day rolling volatility metrics (annualized)  
**Generated By**: `analyze_data.py`  
**Update Frequency**: Each pipeline run

#### Schema

| Column | Data Type | Description | Example | Units |
|--------|-----------|-------------|---------|-------|
| `symbol` | STRING | Stock ticker symbol | `NVDA` | - |
| `ann_vol_20d` | FLOAT | 20-day annualized volatility | `0.2847` | decimal (28.47%) |

#### Calculation Details

```python
# Step 1: Calculate daily returns
daily_return = adj_close.pct_change()

# Step 2: Calculate 20-day rolling standard deviation
rolling_std_20d = daily_return.rolling(window=20).std()

# Step 3: Annualize (multiply by square root of trading days per year)
ann_vol_20d = rolling_std_20d * sqrt(252)

# Step 4: Take most recent non-null value per symbol
latest_vol = ann_vol_20d.groupby('symbol').last()
```

#### Sample Data

```csv
symbol,ann_vol_20d
AAPL,0.2847
MSFT,0.2134
GOOGL,0.3012
AMZN,0.2956
META,0.3421
```

#### Interpretation Guide

- **Volatility Ranges**:
  - `< 0.15` (15%): Low volatility (stable blue chips)
  - `0.15 - 0.30` (15-30%): Moderate volatility (typical for large caps)
  - `> 0.30` (30%+): High volatility (growth stocks, tech)

- **Use Cases**:
  - Risk assessment for portfolio construction
  - Option pricing inputs
  - Comparison across securities
  - Market regime identification (VIX-like measure)

- **Annualization Factor**:
  - √252 assumes 252 trading days per year
  - Converts daily volatility to annual percentage
  - Standard in financial industry

---

## Data Types Reference

### Standard Conventions

| Type | SQLite | CSV/Pandas | Precision | Range |
|------|--------|------------|-----------|-------|
| Date | TEXT | string | Day | 1000-01-01 to 9999-12-31 |
| Symbol | TEXT | string | N/A | Max 10 characters |
| Price | REAL | float64 | 2-4 decimals | 0.01 to 999,999.99 |
| Volume | INTEGER | int64 | Whole numbers | 0 to 2^63-1 |
| Return | REAL | float64 | 6-8 decimals | -1.0 to 100.0 (theoretical) |
| Volatility | REAL | float64 | 4-6 decimals | 0.0 to 10.0 (theoretical) |

### Null Handling

| Field | Null Allowed? | Handling Strategy |
|-------|---------------|-------------------|
| `date` | No | Required for primary key |
| `symbol` | No | Required for primary key |
| `open, high, low, close` | Yes | May occur for halted trading |
| `adj_close` | Yes | Critical; skip returns calculation if null |
| `volume` | Yes | Use 0 or null; exclude from averages if null |
| `daily_return` | Yes | Expected null on first day per symbol |
| `ann_vol_20d` | Yes | Expected null for first 19 days per symbol |

---

## Business Rules & Calculations

### 1. Daily Returns

**Formula**:
```
daily_return = (adj_close_t - adj_close_t-1) / adj_close_t-1
```

**Properties**:
- Calculated per symbol independently
- First observation per symbol will have null return
- Uses adjusted close to account for splits and dividends
- Expressed as decimal (0.01 = 1%)

**Edge Cases**:
- If `adj_close_t-1 = 0`: Return is undefined (should not occur in practice)
- If `adj_close_t-1 is null`: Return is null
- Large returns (>50%) may indicate corporate actions (splits) not properly adjusted

---

### 2. Rolling Volatility

**Formula**:
```
ann_vol_20d = sqrt(252) × std_dev(daily_returns over 20 days)
```

**Properties**:
- Requires minimum 20 valid returns
- Standard deviation uses sample estimator (n-1 denominator)
- Annualization assumes 252 trading days per year
- More recent returns weighted equally (simple rolling window)

**Alternative Approaches** (not implemented):
- Exponentially weighted moving average (EWMA)
- GARCH models
- Realized volatility from intraday data

---

### 3. Summary Statistics

**Observations Count**:
```
obs = count(non-null daily returns)
```

**Mean Daily Return**:
```
mean_daily_return = sum(daily_returns) / obs
```
- Simple arithmetic mean
- May be annualized by multiplying by 252 (not done here)

**Standard Deviation**:
```
std_daily_return = sqrt(sum((return_i - mean)^2) / (obs - 1))
```
- Sample standard deviation (Bessel's correction)
- Daily frequency (not annualized)

**Average Volume**:
```
avg_volume = sum(volume) / count(volume)
```
- Excludes null volumes
- Integer truncation may apply

---

## Data Quality Notes

### Known Issues & Limitations

1. **Market Data Source**:
   - Source: Yahoo Finance via `yfinance` library
   - Reliability: Community-maintained; subject to API changes
   - Coverage: US equities only; no international symbols
   - Gaps: May miss data for halted trading, IPO periods, delisted stocks

2. **Date Handling**:
   - Non-trading days (weekends, holidays) are excluded
   - Expected: ~252 trading days per year (~21 per month)
   - Date ranges may vary by symbol (IPO date, data availability)

3. **Adjusted Close**:
   - Yahoo Finance provides split/dividend adjusted prices
   - Historical adjustments may be revised retroactively
   - For precise backtesting, consider using point-in-time data

4. **Volatility Calculations**:
   - 20-day window requires 20 valid observations
   - Symbols with <20 days will have null volatility
   - Annualization factor (252) assumes US market schedule

5. **Volume Data**:
   - Reported in number of shares, not notional value
   - Does not distinguish between lit/dark pool volume
   - May be revised T+1 by exchanges

### Data Validation Checks

**Recommended validations** (not automatically implemented):

```sql
-- Check for duplicate records
SELECT date, symbol, COUNT(*) 
FROM prices_daily 
GROUP BY date, symbol 
HAVING COUNT(*) > 1;

-- Check for negative prices (data error)
SELECT * FROM prices_daily 
WHERE open < 0 OR high < 0 OR low < 0 OR close < 0 OR adj_close < 0;

-- Check for high-low inversions
SELECT * FROM prices_daily 
WHERE high < low;

-- Check for open-high-low-close consistency
SELECT * FROM prices_daily 
WHERE open > high OR open < low OR close > high OR close < low;

-- Check for missing adjusted close (critical for returns)
SELECT COUNT(*) FROM prices_daily WHERE adj_close IS NULL;

-- Check for extreme returns (possible data error or corporate action)
WITH returns AS (
    SELECT 
        symbol,
        date,
        adj_close / LAG(adj_close) OVER (PARTITION BY symbol ORDER BY date) - 1 AS ret
    FROM prices_daily
)
SELECT * FROM returns WHERE ABS(ret) > 0.5;  -- Flag 50%+ daily moves
```

### Data Refresh Guidelines

1. **Frequency**: Daily after market close (4:00 PM ET)
2. **Lookback**: Default 365 days; adjust as needed
3. **Incremental Updates**: Upsert pattern handles overlapping data
4. **Historical Corrections**: Re-fetch entire date range if source data revised
5. **New Symbols**: Add to ticker list in `fetch_data.py`

---

## Appendix: Field Ranges & Examples

### Typical Value Ranges (Large-Cap US Equities)

| Field | Typical Min | Typical Max | Exceptional |
|-------|-------------|-------------|-------------|
| `open, high, low, close` | $10 | $500 | $1000+ (BRK.A) |
| `volume` | 1M | 100M | 500M+ (penny stocks, news events) |
| `daily_return` | -0.10 (-10%) | +0.10 (+10%) | ±0.20 (20%) on earnings |
| `ann_vol_20d` | 0.10 (10%) | 0.50 (50%) | 1.0+ (100%) during crises |

### Symbol List (Default)

| Symbol | Company | Sector | Typical Volatility |
|--------|---------|--------|-------------------|
| AAPL | Apple Inc. | Technology | Moderate |
| MSFT | Microsoft Corp. | Technology | Moderate |
| GOOGL | Alphabet Inc. | Technology | Moderate |
| AMZN | Amazon.com Inc. | Consumer Cyclical | High |
| META | Meta Platforms Inc. | Technology | High |
| JPM | JPMorgan Chase & Co. | Financial | Moderate |
| V | Visa Inc. | Financial | Low-Moderate |
| PG | Procter & Gamble Co. | Consumer Defensive | Low |
| XOM | Exxon Mobil Corp. | Energy | Moderate |
| NVDA | NVIDIA Corp. | Technology | Very High |

---

## Document Metadata

**Author**: WRDS Data Ingestion Demo Project  
**Version**: 1.0  
**Last Updated**: 2025-10-27  
**Applies To**: Pipeline versions 1.x  
**Next Review**: 2026-01-01  

**Change Log**:
- 2025-10-27: Initial version documenting all schemas and calculations
